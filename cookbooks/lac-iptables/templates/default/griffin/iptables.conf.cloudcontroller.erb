*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:ANNAI_LABS  -  [0:0]
:OPENSTACK_API - [0:0]
:OPENSTACK_PUBLIC_API - [0:0]
:DNS - [0:0]
:<%= node['canary'].upcase %> - [0:0]

# accept opened connections
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT

# allow full privnet access
-A INPUT -s 10.24.0.0/16 -j ACCEPT
-A OUTPUT -d 10.24.0.0/16 -j ACCEPT


#allow nagios
-A INPUT  -s 10.103.110.249 -j ACCEPT
-A OUTPUT  -d 10.103.110.249 -j ACCEPT
#allow icinga
-A INPUT  -s 10.8.0.21 -j ACCEPT
-A OUTPUT  -d 10.8.0.21 -j ACCEPT
#allow logstash
-A INPUT  -s 10.8.0.22 -j ACCEPT
-A OUTPUT  -d 10.8.0.22 -j ACCEPT

#Allow Proxy
-A INPUT -ptcp -mtcp -s 10.24.0.0/8 --dport 3128 -j ACCEPT
-A INPUT -ptcp -mtcp -s 10.24.64.0/8 --dport 3128 -j ACCEPT


-A INPUT -p tcp -m tcp --dport 8773:8777 -j OPENSTACK_API
-A INPUT -p tcp -m tcp --dport 5000 -j OPENSTACK_API
-A INPUT -p tcp -m tcp --dport 9191 -j OPENSTACK_API
-A INPUT -p tcp -m tcp --dport 9292 -j OPENSTACK_API
-A INPUT -p tcp -m tcp --dport 35357 -j OPENSTACK_API
#-A OPENSTACK_API -s 10.103.114.0/24 -j ACCEPT 

#Public Openstack API Opening
# keystone
-A INPUT -p tcp -m tcp --dport 45357 -j OPENSTACK_API 
-A OPENSTACK_API -j ACCEPT 

# allow full privnet access
-A INPUT -s 172.17.192.0/18 -d 172.167.192.0/18 -j ACCEPT
-A OUTPUT -s 172.17.192.0/18 -d 172.167.192.0/18 -j ACCEPT

# allow public ssh access
-A INPUT -m tcp -p tcp --dport 22 -j ACCEPT
-A OUTPUT -m tcp -p tcp  --dport 22  -j ACCEPT
-A OUTPUT -m tcp -p tcp  --sport 22  -j ACCEPT

# allow MDNS traffic
-A INPUT -p udp --dport 5353 -d 224.0.0.251 -j ACCEPT

#Allow in rsync
-A INPUT -m tcp -p tcp --dport 873 -j ACCEPT

#Allow UDR
-A INPUT -p udp -m udp --dport 9000:9010 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 9000:9010 -j ACCEPT
-A OUTPUT -p udp -m udp --dport 9000:9010 -j ACCEPT
-A OUTPUT -p tcp -m tcp --dport 9000:9010 -j ACCEPT

#Allow in tukey
#-A INPUT -i p3p1.3523 -p tcp --dport 80 -j ACCEPT
#-A INPUT -i p3p1.3523 -p tcp --dport 443 -j ACCEPT

#ASPERA
-A INPUT -p udp -m udp --dport 33001:33020  -j ACCEPT
-A OUTPUT -p udp -m udp --dport 33001:33020  -j ACCEPT

# accept anything on loopback
-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT

#Nagios and Cacti
-A INPUT -pudp -mudp -s 10.103.110.249 -j ACCEPT
-A INPUT -pudp -mudp --dport 161 -j REJECT

# allow pings
-A INPUT -p ICMP --icmp-type echo-request -j ACCEPT
-A OUTPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT

#DNS
-A OUTPUT -p tcp -m tcp --dport 53 -j DNS
-A OUTPUT -p udp -m udp --dport 53 -j DNS

-A DNS -d 10.8.0.21 -j ACCEPT
-A DNS -d 10.8.0.21 -j ACCEPT
-A DNS -d 192.170.228.84 -j ACCEPT
-A DNS -d 192.170.228.88 -j ACCEPT

COMMIT

# Completed on Thu Jan 24 12:23:11 2013
# Generated by iptables-save v1.4.12 on Thu Jan 24 12:23:11 2013
*nat
:PREROUTING ACCEPT [8316048:1925899220]
:INPUT ACCEPT [4552035:451881410]
:OUTPUT ACCEPT [3668454:221800830]
:POSTROUTING ACCEPT [3614145:218058996]
-A POSTROUTING -o eth2.3523 -j MASQUERADE
COMMIT
