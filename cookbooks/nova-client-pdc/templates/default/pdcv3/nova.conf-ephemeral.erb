## This file managed by Chef, all changes will be overwritten ##
## epherma

[DEFAULT]

#Scheduler
#scheduler_default_filters = AvailabilityFilter, CoreFilter, RamFilter
scheduler_default_filters =  AggregateMultiTenancyIsolation,AggregateInstanceExtraSpecsFilter,AvailabilityZoneFilter,CoreFilter, RamFilter
scheduler_driver=nova.scheduler.filter_scheduler.FilterScheduler
cpu_allocation_ratio=1.0
ram_allocation_ratio=1.0

#Default quota
quota_cores = <%= node['nova']['default_cores'] %>
quota_fixed_ips = <%= node['nova']['default_fixed_ips'] %>
quota_floating_ips = <%= node['nova']['default_floating_ips'] %>
quota_instances = <%= node['nova']['default_number_instances'] %>
quota_ram = <%= node['nova']['default_ram'] %>


#Keep Connections under controll
#metadata_workers=5
#osapi_compute_workers=5
#ec2_workers=5
metadata_workers=2
osapi_compute_workers=2
ec2_workers=2
#https://bugs.launchpad.net/nova/+bug/1225655
rpc_conn_pool_size=100
rpc_response_timeout=200
rabbit_retry_interval=5
rabbit_retry_backoff=5


##Dnsmasq sighup issue
##It either is SIGHUP to fast or not at all, whcih means dhcp leases arent loaded into dnsmasq
report_interval = 15
agent_down_time = 30


dhcpbridge_flagfile=/etc/nova/nova.conf
dhcpbridge=/usr/bin/nova-dhcpbridge
logdir=/var/log/nova
state_path=/var/lib/nova
lock_path=/var/lock/nova
force_dhcp_release=True
iscsi_helper=tgtadm
libvirt_use_virtio_for_bridges=True
connection_type=libvirt
root_helper=sudo nova-rootwrap /etc/nova/rootwrap.conf
verbose=True
ec2_private_dns_show_ip=True
api_paste_config=/etc/nova/api-paste.ini
volumes_path=/var/lib/nova/volumes
enabled_apis=ec2,osapi_compute,metadata

auth_strategy=keystone

multi_instance_display_name_template = %(name)s-%(count)s


#Legacy Networking
network_manager=nova.network.manager.FlatDHCPManager
firewall_driver=nova.virt.libvirt.firewall.IptablesFirewallDriver
network_size=65535
allow_same_net_traffic=True
multi_host=True
send_arp_for_ha=True
share_dhcp_address=True
force_dhcp_release=True
flat_interface=<%= node['nova']['flat_interface'] %>
public_interface=<%= node['nova']['public_interface'] %>
flat_network_bridge=<%= node['nova']['flat_network_bridge'] %>
network_api_class = nova.network.api.API
security_group_api = nova
#iptables_top_regex='\-\S FORWARD'
iptables_top_regex='\-\S\s+INPUT|\-\S\s+OUTPUT|\-\S\s+FORWARD'

###Neutron
#network_api_class = nova.network.neutronv2.api.API
#neutron_url = http://<%= node['neutron']['host'] %>:9696
#neutron_auth_strategy = keystone
#neutron_admin_tenant_name = service
#neutron_admin_username = neutron
#neutron_admin_password = <%= node['neutron']['passwd'] %>
#neutron_admin_auth_url = http://<%= node['neutron']['host'] %>:35357/v2.0
#linuxnet_interface_driver = nova.network.linux_net.LinuxOVSInterfaceDriver
#firewall_driver = nova.virt.firewall.NoopFirewallDriver
#security_group_api = neutron

#VNC
my_ip=<%=node['ipaddress']%>
vncserver_listen=<%=node['ipaddress']%>
vncserver_proxyclient_address=<%=node['ipaddress']%>

#RabbitMQ
rpc_backend = nova.rpc.impl_kombu
rabbit_host = <%= node['rabbitmq']['host'] %>
rabbit_password = <%= node['rabbitmq']['passwd'] %>

#Glance
glance_host=<%= node['glance']['host'] %>

#Ceilometer
instance_usage_audit = True
instance_usage_audit_period = hour
notify_on_state_change = vm_and_task_state
notification_driver = nova.openstack.common.notifier.rpc_notifier
notification_driver = ceilometer.compute.nova_notifier

#Ephemeral disks should default to ext4.  Doing this in hopes of making cloud-init happier
default_ephemeral_format = ext4
#Not sure we still need this next line...probably not.
preallocate_images = space

<% if node['nova'].include?'rbd_secret_uuid' %>
#Kyle, this one is the right file
#This node should NOT use ceph for the ephemeral
#Or probably anything else
##Ceph backend
libvirt_images_type=raw
#libvirt_images_rbd_pool=vms
#libvirt_images_rbd_ceph_conf=/etc/ceph/ceph.conf
#rbd_user=cinder
#rbd_secret_uuid=<%= node['nova']['rbd_secret_uuid'] %>
#libvirt_inject_password=false
#libvirt_inject_key=false
#libvirt_inject_partition=-2
<% else %>
### CEPH BACKEND DISABLED ###
### If this isn't what you want, you need to put an rbd_secret_uuid node in the environment file ###
<% end %>

[database]
connection = mysql://nova:<%= node['mysql']['nova_passwd'] %>@<%= node['mysql']['host'] %>/nova
max_pool_size=30
max_retries=20
retry_interval=15
connection_debug=20


[keystone_authtoken]
<% if node['keystone']['ssl']  == "true" %>

auth_uri = http://<%= node['keystone']['host'] %>:5000
auth_host = <%= node['keystone']['host'] %>
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = nova
admin_password = <%= node['nova']['passwd'] %>

<% else %>

auth_uri = http://<%= node['keystone']['host'] %>:45000
auth_host = <%= node['keystone']['host'] %>
auth_port = 45357
auth_protocol = https
admin_tenant_name = service
admin_user = nova
admin_password = <%= node['nova']['passwd'] %>

<% end %>
# This file was auto-generated by Chef for <%=node['ipaddress']%>
