## This file managed by Chef, all changes will be overwritten ##

#This __should__ give preference to ipv4 address lookups
dns_v4_first on

http_port <%=node["network"]["interfaces"]["virbr1"]["addresses"].collect{|k,v| k if v["family"]=='inet'}.compact.first%>:3128

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

#acl localhost src 127.0.0.1/32 ::1
#acl to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1
#acl localnet src 10.1.0.0/8

acl Safe_ports port 80          # http
acl Safe_ports port 443          # https
acl Safe_ports port 8080          # https
acl SSL_ports port 443    #https for CONNECT acl
acl ftp_ports port 20
acl ftp_ports port 21
acl FTP proto FTP
always_direct allow FTP

acl CONNECT method CONNECT
http_access allow SSL_ports CONNECT

#----------------------------------
#General whitelists go HERE
#----------------------------------

#These files should live in the same directory as squid.conf
#Use the appropriate whitelist
acl web_whitelist dstdomain "/etc/squid3/web_whitelist"
acl web_wildcard_whitelist dstdomain "/etc/squid3/web_wildcard_whitelist"
acl ftp_whitelist dstdomain "/etc/squid3/ftp_whitelist"

http_access allow Safe_ports web_whitelist
http_access allow Safe_ports web_wildcard_whitelist

http_access allow ftp_ports ftp_whitelist
http_access allow Safe_ports ftp_whitelist

#---------------------------------
# Do not edit below this line for general web-access
# Everything below here is for specific services
# --------------------------------



#metadata-pdc.opensciencedatacloud.org
acl Safe_ports_metadata port 5984 #non ssl
acl Safe_ports_metadata port 80 #non ssl
acl Safe_ports_metadata port 6984 #ssl
acl Safe_ports_metadata port 443 #ssl
acl SSL_ports_metadata port 6984
acl SSL_ports_metadata port 443

acl MetadataService dstdomain metadata-pdc.opensciencedatacloud.org

http_access allow Safe_ports_metadata MetadataService
http_access allow Safe_ports MetadataService
http_access allow SSL_ports_metadata  CONNECT

#OpenStack API
acl OpenStack  port 5000
acl OpenStack  port 8776
acl OpenStack  port 6666
acl OpenStack  port 9292
acl OpenStack  port 35357
acl OpenStack  port 6081
acl OpenStack  port 8773
acl OpenStack  port 8774
acl OpenStack  port 9191
acl OpenStack  port 8775

acl nova    dstdomain cloud-controller cloud-proxy api-gdc-av1.osdc.io api-gdc-av2.osdc.io cloud-proxy.novalocal

http_access allow nova
http_access allow OpenStack nova

#Annai
acl annai_upload_ports port 20892-20923
acl annai_upload_ports port 21111
acl annai_upload_ports port 443
acl annai_upload_ports port 6881-6899
acl annai_upload_ports port 7881-7899
acl annai_upload_ports port 8881-8899
acl annai_upload_ports port 9881-9899

acl annai_upload_site dstdomain gtrepo-osdc.annailabs.com  gtrepo-ebi.annailabs.com
acl cghub dstdomain  .cghub.ucsc.edu

http_access allow Safe_ports cghub
http_access allow annai_upload_ports cghub
http_access allow annai_upload_ports annai_upload_site


#IGSB
acl igsbimg_acl port 5984
acl igsbimg_acl port 5900
acl igsbimg_acl port 80
acl igsbimg_acl port 443

acl igsbimg dstdomain igsbimg.uchicago.edu #KS: allison request

http_access allow igsbimg_acl igsbimg

#Our own sites, SSL only
acl osdc_sites dstdomain .opensciencedatacloud.org # RP:L ticket 2445
http_access allow osdc_sites SSL_ports


#nessus
acl Nessus_port port 8843
acl nessus dstdomain 192.170.230.209 .tenable.com #KS: 29012015 For Nessus

http_access allow Nessus_port nessus
http_access allow Safe_ports nessus
http_access deny all

persistent_request_timeout 5 seconds

# vi:syntax=squid.conf
# This file was auto-generated by Chef for <%=node['ipaddress']%>
